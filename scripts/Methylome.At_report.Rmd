---
title: "[Methylome.At](https://github.com/Yo-yerush/Methylome.At) report"
date: "`r format(Sys.Date(), '%d, %B, %Y')`"
output:
  html_document:
    toc: false
    toc_float: false
    number_sections: false
    df_print: paged
    self_contained: true
    theme: spacelab

params:
  var1: null
  var2: null
  var1_path: null
  var2_path: null
  Methylome.At_path: "."

  annotation_file: "./annotation_files/Methylome.At_annotations.csv.gz"
  description_file: "./annotation_files/Methylome.At_annotations.csv.gz"
  TEs_file: "./annotation_files/Methylome.At_annotations.csv.gz"

  minProportionDiff: [0.4, 0.2, 0.1]    # CG, CHG, CHH
  binSize: 100
  minCytosinesCount: 4
  minReadsPerCytosine: 4
  pValueThreshold: 0.05
  methyl_files_type: "CX_report"
  img_type: "svg"
  n.cores: 8

  analyze_DMRs: true
  run_PCA_plot: true
  run_total_meth_plot: true
  run_CX_Chrplot: true
  run_TEs_distance_n_size: true
  total_meth_annotation: true
  run_TF_motifs: true
  run_functional_groups: true
  run_GO_analysis: false
  run_KEGG_pathways: false

  analyze_strand_asymmetry_DMRs: false
  analyze_DMVs: false
  analyze_dH: false
  run_TE_metaPlots: false
  run_GeneBody_metaPlots: false
  run_GeneFeatures_metaPlots: false
  gene_features_binSize: 10
  metaPlot.random.genes: 10000

  # ---------------------------
  # Report layout (images only)
  # ---------------------------
  plot_max_width_px: 1100      # max width for each plot
  plot_max_height_px: 500      # cap plot height (prevents huge SVG/PNG)
  plot_gap_px: 5              # gap between plots in grids
  default_plot_cols: 1         # default columns for multi-plot sections

  # If TRUE: copy plots next to the HTML (robust links even when HTML is saved inside results/<comparison>)
  copy_images_next_to_report: true
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
suppressPackageStartupMessages({ library(knitr) })

stop_if_missing <- function(x, name) {
  if (is.null(x) || length(x) == 0 || !nzchar(as.character(x)[1])) stop("Missing required param: ", name)
}
stop_if_missing(params$var1, "var1")
stop_if_missing(params$var2, "var2")

root <- params$Methylome.At_path
if (!dir.exists(root)) stop("Methylome.At_path does not exist: ", root)
knitr::opts_knit$set(root.dir = root)

comparison_name <- paste0(params$var2, "_vs_", params$var1)
exp_path <- file.path("results", comparison_name)
if (!dir.exists(file.path(root, exp_path)) && !dir.exists(exp_path)) {
  # When root.dir is set, relative paths are resolved from it. This check is defensive.
  stop("Results folder not found: ", exp_path)
}

# Output folders (match Methylome.At_main.R)
total_meth_path <- file.path(exp_path, "total_methylation_analysis")
PCA_plots_path <- file.path(total_meth_path, "PCA_plots")
meth_levels_path <- file.path(total_meth_path, "methylation_levels")
ChrPlot_CX_path <- file.path(total_meth_path, "ChrPlot_CX")
ChrPlot_subCX_path <- file.path(ChrPlot_CX_path, "subCX")
TEs_distance_n_size_path <- file.path(total_meth_path, "TE_size_n_distance")
total_meth_annotation_path <- file.path(total_meth_path, "total_methylation_annotations")
TF_motifs_path <- file.path(total_meth_path, "TF_motifs")

DMRs_analysis_path <- file.path(exp_path, "DMR_analysis")
gainORloss_path <- file.path(DMRs_analysis_path, "gain_OR_loss")
genome_ann_path <- file.path(DMRs_analysis_path, "genome_annotation")
ChrPlots_DMRs_path <- file.path(DMRs_analysis_path, "ChrPlot_DMRs")
DMRs_bigWig_path <- file.path(DMRs_analysis_path, "DMRs_bigWig")

strand_asymmetry_path <- file.path(exp_path, "Strand_Asymmetry_DMRs")
DMV_analysis_path <- file.path(exp_path, "DMV_analysis")
dH_path <- file.path(exp_path, "deltaH")
dH_ann_path <- file.path(dH_path, "genome_annotation")
metaA <- file.path(exp_path, "MetaPlots")
metaB <- file.path(exp_path, "metaPlots")
meta_dir <- if (dir.exists(metaA)) metaA else if (dir.exists(metaB)) metaB else NA_character_

# ----------------------------
# Plot rendering utilities (IMAGES ONLY: SVG/PNG/JPEG/GIF)
# ----------------------------

# Determine where the HTML will be written; used for copying plot assets near the report.
get_report_dir <- function() {
  od <- tryCatch(knitr::opts_knit$get("output.dir"), error = function(e) NULL)
  if (!is.null(od) && nzchar(od)) return(normalizePath(od, winslash = "/", mustWork = FALSE))
  co <- tryCatch(knitr::current_output(), error = function(e) NULL)
  if (!is.null(co) && nzchar(co)) return(dirname(normalizePath(co, winslash = "/", mustWork = FALSE)))
  # common default when output_file is inside results/<comparison>
  normalizePath(exp_path, winslash = "/", mustWork = FALSE)
}
report_dir <- get_report_dir()

# Where we store image assets for stable linking
assets_dir <- file.path(report_dir, paste0(comparison_name, "_plots"))
if (isTRUE(params$copy_images_next_to_report)) dir.create(assets_dir, recursive = TRUE, showWarnings = FALSE)

# Convert an absolute or relative path to a relative path under project root (root.dir)
project_rel <- function(p) {
  if (is.null(p) || !nzchar(p)) return(p)
  # If already relative, keep it
  if (!grepl("^(/|[A-Za-z]:)", p)) return(p)
  wd <- tryCatch(normalizePath(getwd(), winslash = "/", mustWork = FALSE), error = function(e) "")
  pa <- tryCatch(normalizePath(p, winslash = "/", mustWork = FALSE), error = function(e) p)
  if (nzchar(wd) && startsWith(pa, paste0(wd, "/"))) sub(paste0("^", wd, "/"), "", pa) else pa
}

# Copy an image into assets_dir while preserving its relative path under exp_path
asset_link <- function(img_file) {
  if (!file.exists(img_file)) return(NA_character_)
  # ignore PDFs completely (report is non-PDF)
  if (tolower(tools::file_ext(img_file)) == "pdf") return(NA_character_)

  if (!isTRUE(params$copy_images_next_to_report)) return(chartr("\\", "/", project_rel(img_file)))

  exp_abs <- normalizePath(exp_path, winslash = "/", mustWork = FALSE)
  img_abs <- normalizePath(img_file, winslash = "/", mustWork = FALSE)

  rel <- if (startsWith(img_abs, paste0(exp_abs, "/"))) sub(paste0("^", exp_abs, "/"), "", img_abs) else basename(img_abs)
  dst <- file.path(assets_dir, rel)
  dir.create(dirname(dst), recursive = TRUE, showWarnings = FALSE)
  file.copy(img_abs, dst, overwrite = TRUE)

  # return link relative to report_dir
  rd_abs <- normalizePath(report_dir, winslash = "/", mustWork = FALSE)
  dst_abs <- normalizePath(dst, winslash = "/", mustWork = FALSE)
  link <- if (startsWith(dst_abs, paste0(rd_abs, "/"))) sub(paste0("^", rd_abs, "/"), "", dst_abs) else dst_abs
  chartr("\\", "/", link)
}

is_media <- function(x) {
  ext <- tolower(tools::file_ext(x))
  ext %in% c("png","jpg","jpeg","svg","gif")
}

list_media_files <- function(dir_path, recursive = FALSE, pattern = NULL) {
  if (!dir.exists(dir_path)) return(character())
  files <- list.files(dir_path, full.names = TRUE, recursive = recursive)
  files <- files[!file.info(files)$isdir]
  files <- files[sapply(files, is_media)]
  if (!is.null(pattern)) files <- files[grepl(pattern, basename(files), ignore.case = TRUE)]
  files
}

context_rank <- function(x) {
  b <- tolower(basename(x))
  if (grepl("all_contexts|allcontexts|all", b)) return(0L)
  if (grepl("\\bcg\\b", b)) return(1L)
  if (grepl("\\bchg\\b", b)) return(2L)
  if (grepl("\\bchh\\b", b)) return(3L)
  9L
}

order_files <- function(files) {
  if (length(files) == 0) return(files)
  files[order(vapply(files, context_rank, integer(1)), tolower(basename(files)))]
}

emit_grid <- function(files, cols = params$default_plot_cols, max_height_px = NULL) {
  files <- files[file.exists(files)]
  files <- order_files(files)
  if (length(files) == 0) {
    cat("_No plot files found._

")
    return(invisible(NULL))
  }

  cols <- as.integer(cols)
  if (is.na(cols) || cols < 1L) cols <- 1L

  mh <- max_height_px
  if (!is.null(mh)) {
    mh <- as.integer(mh)
    if (is.na(mh) || mh < 50L) mh <- NULL
  }

  if (is.null(mh)) {
    cat(sprintf('<div class="plot-grid" style="--cols:%d;">
', cols))
  } else {
    cat(sprintf('<div class="plot-grid" style="--cols:%d; --img-max-height:%dpx;">
', cols, mh))
  }

  for (f in files) {
    src <- asset_link(f)
    if (is.na(src) || !nzchar(src)) next
    cat(sprintf('  <div class="plot-cell"><img src="%s" loading="lazy"></div>
', src))
  }
  cat('</div>

')
  invisible(NULL)
}

emit_dir <- function(dir_path, recursive = FALSE, cols = params$default_plot_cols, pattern = NULL, max_height_px = NULL) {
  files <- list_media_files(dir_path, recursive = recursive, pattern = pattern)
  emit_grid(files, cols = cols, max_height_px = max_height_px)
}

# Compact printing of params that may be vectors
val1 <- function(x) {
  if (is.null(x) || length(x) == 0) return(NA_character_)
  paste(as.character(x), collapse = ", ")
}
```

```{r plot-style, results='asis', echo=FALSE}
cat(sprintf('<style>
:root{
  --plot-max-width: %dpx;
  --plot-max-height: %dpx;
  --plot-gap: %dpx;
}
.plot-grid{
  display:flex;
  flex-wrap:wrap;
  gap: var(--plot-gap);
  justify-content: center;
  align-items:flex-start;
  margin: 10px 0 18px 0;
  --img-max-height: var(--plot-max-height);
}
.plot-cell{
  flex: 0 0 calc((100%% - (var(--cols) - 1) * var(--plot-gap)) / var(--cols));
  max-width: var(--plot-max-width);
}
.plot-cell img{
  width:100%%;
  height:auto;
  max-height: var(--img-max-height);
  object-fit: contain;
  display:block;
}
</style>', as.integer(params$plot_max_width_px), as.integer(params$plot_max_height_px), as.integer(params$plot_gap_px)))
```


# `r params$var2` vs `r params$var1`: Results Overview {.tabset}

## QC

**Comparison:** `r params$var2` vs `r params$var1`  
**Results folder:** `r file.path(root, exp_path)`

### Conversion rate

Chloroplast DNA is expected to be largely unmethylated. High C→T conversion on ChrC is a practical estimate of bisulfite conversion efficiency.

```{r conversion-rate, results='asis'}
conv_path <- file.path(exp_path, "conversion_rate.csv")
if (!file.exists(conv_path)) {
  cat(sprintf("_Missing file:_ `%s`_\n\n", conv_path))
} else {
  conv <- read.csv(conv_path, check.names = FALSE)
  kable(conv)
}
```

## Total methylation {.tabset}

```{r total-meth-tabs, results='asis'}
# Each enabled analysis becomes a sub-tab
if (isTRUE(params$run_PCA_plot)) {
  cat("### PCA (Principal Component Analysis)\n\n")
  cat("PCA compresses genome-wide methylation into a few axes. Replicates should cluster; separation between conditions suggests global methylation shifts.\n\n")
  emit_dir(PCA_plots_path, recursive = FALSE, cols = 4, max_height_px = params$plot_max_height_px)
}

if (isTRUE(params$run_total_meth_plot)) {
  cat("### Total methylation levels\n\n")
  cat("Global methylation (%) summarized per context and condition.\n\n")
  emit_dir(meth_levels_path, recursive = FALSE, cols = 3, max_height_px = params$plot_max_height_px/1.5)
}

if (isTRUE(params$run_CX_Chrplot)) {
  cat("### Chromosome methylation profiles {.tabset}\n\n")
  cat("Chromosome-scale methylation. Often highlights pericentromeric/heterochromatin-linked changes.\n\n")

  # Split into context subtabs if possible
  all_files <- list_media_files(ChrPlot_CX_path, recursive = FALSE)
  if (length(all_files) == 0) {
    cat("_No chromosome methylation plots found._\n\n")
  } else {
    # Try to group by context keywords in filenames
    grp_all <- all_files[grepl("all_contexts|allcontexts|all", basename(all_files), ignore.case = TRUE)]
    grp_cg  <- all_files[grepl("\\bcg\\b",  basename(all_files), ignore.case = TRUE)]
    grp_chg <- all_files[grepl("\\bchg\\b", basename(all_files), ignore.case = TRUE)]
    grp_chh <- all_files[grepl("\\bchh\\b", basename(all_files), ignore.case = TRUE)]
    grp_rest <- setdiff(all_files, c(grp_all, grp_cg, grp_chg, grp_chh))

    if (length(grp_all) > 0) { cat("#### All contexts\n\n"); emit_grid(grp_all, cols = 1, max_height_px = params$plot_max_height_px) }
    if (length(grp_cg)  > 0) { cat("#### CG\n\n");          emit_grid(grp_cg,  cols = 1, max_height_px = params$plot_max_height_px) }
    if (length(grp_chg) > 0) { cat("#### CHG\n\n");         emit_grid(grp_chg, cols = 1, max_height_px = params$plot_max_height_px) }
    if (length(grp_chh) > 0) { cat("#### CHH\n\n");         emit_grid(grp_chh, cols = 1, max_height_px = params$plot_max_height_px) }

    # If filenames don't include contexts, show remaining as their own subtabs (one file per tab)
    if (length(grp_rest) > 0) {
      for (f in order_files(grp_rest)) {
        cat("#### ", tools::file_path_sans_ext(basename(f)), "\n\n", sep="")
        emit_grid(c(f), cols = 1, max_height_px = params$plot_max_height_px)
      }
    }
  }

  if (dir.exists(ChrPlot_subCX_path)) {
    sub_files <- list_media_files(ChrPlot_subCX_path, recursive = TRUE)
    if (length(sub_files) > 0) {
      cat("#### subCX\n\n")
      emit_grid(sub_files, cols = 1, max_height_px = params$plot_max_height_px)
    }
  }
}

if (isTRUE(params$run_TEs_distance_n_size)) {
  cat("### TE methylation vs TE size & centromere distance\n\n")
  emit_dir(TEs_distance_n_size_path, recursive = TRUE, cols = 4, max_height_px = params$plot_max_height_px)
}

if (isTRUE(params$total_meth_annotation)) {
  cat("### Total methylation across genome annotations\n\n")
  emit_dir(total_meth_annotation_path, recursive = TRUE, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px)
}

if (isTRUE(params$run_TF_motifs)) {
  cat("### TF motif analysis {.tabset}\n\n")

  tf_files <- list_media_files(TF_motifs_path, recursive = TRUE)
  if (length(tf_files) == 0) {
    cat("_No TF motif plots found._\n\n")
  } else {
    # Group by context when possible; otherwise one file per tab
    tf_all <- tf_files[grepl("all_contexts|allcontexts|all", basename(tf_files), ignore.case = TRUE)]
    tf_cg  <- tf_files[grepl("\\bcg\\b",  basename(tf_files), ignore.case = TRUE)]
    tf_chg <- tf_files[grepl("\\bchg\\b", basename(tf_files), ignore.case = TRUE)]
    tf_chh <- tf_files[grepl("\\bchh\\b", basename(tf_files), ignore.case = TRUE)]
    tf_rest <- setdiff(tf_files, c(tf_all, tf_cg, tf_chg, tf_chh))

    if (length(tf_all) > 0) { cat("#### All contexts\n\n"); emit_grid(tf_all, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px) }
    if (length(tf_cg)  > 0) { cat("#### CG\n\n");          emit_grid(tf_cg,  cols = params$default_plot_cols, max_height_px = params$plot_max_height_px) }
    if (length(tf_chg) > 0) { cat("#### CHG\n\n");         emit_grid(tf_chg, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px) }
    if (length(tf_chh) > 0) { cat("#### CHH\n\n");         emit_grid(tf_chh, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px) }

    if (length(tf_rest) > 0) {
      for (f in order_files(tf_rest)) {
        cat("#### ", tools::file_path_sans_ext(basename(f)), "\n\n", sep="")
        emit_grid(c(f), cols = 1, max_height_px = params$plot_max_height_px)
      }
    }
  }
}
```
## DMRs {.tabset}

### Settings

```{r dmrs-settings-table, results='asis'}
settings <- data.frame(
  Setting = c("methyl_files_type","binSize (bp)","minCytosinesCount","minReadsPerCytosine","pValueThreshold","minProportionDiff (CG,CHG,CHH)","img_type","n.cores"),
  Value = c(val1(params$methyl_files_type), val1(params$binSize), val1(params$minCytosinesCount), val1(params$minReadsPerCytosine),
            val1(params$pValueThreshold), val1(params$minProportionDiff), val1(params$img_type), val1(params$n.cores)),
  Description = c(
    "Type of input methylation files (e.g., CX_report).",
    "Genome tiling window size used to reduce per-site noise.",
    "Minimum informative cytosines required per bin.",
    "Per-site coverage filter applied before summarizing bins.",
    "Statistical cutoff for significance (p-value).",
    "Minimal ΔmC thresholds for CG, CHG and CHH contexts.",
    "Image output format for plots (svg/png/jpeg/gif).",
    "Number of CPU cores used for parallel steps."
  ),
  check.names = FALSE,
  stringsAsFactors = FALSE
)
knitr::kable(settings)
```

```{r dmrs-tabs, results='asis'}
if (isTRUE(params$analyze_DMRs)) {
  # Density
  dens <- list.files(DMRs_analysis_path, pattern = "DMRs_Density.*\\.(png|svg|jpg|jpeg|gif)$", full.names = TRUE, ignore.case = TRUE)
  if (length(dens) > 0) {
    cat("### Density\n\n")
    emit_grid(dens, cols = 1, max_height_px = params$plot_max_height_px)
  }

  # Gain/Loss
  cat("### Gain/Loss\n\n")
  gl_files <- list_media_files(gainORloss_path, recursive = TRUE)
  pie_files <- gl_files[grepl("pie", basename(gl_files), ignore.case = TRUE)]
  other_files <- setdiff(gl_files, pie_files)

  if (length(other_files) > 0) {
    emit_grid(other_files, cols = 3, max_height_px = params$plot_max_height_px/2)
  }
  if (length(pie_files) > 0) {
    emit_grid(pie_files, cols = 3, max_height_px = params$plot_max_height_px/5)
  }

  # Chromosome distribution
  cat("### Chromosome plots\n\n")
  emit_dir(ChrPlots_DMRs_path, recursive = TRUE, cols = 1, max_height_px = params$plot_max_height_px/3)

  # Genome annotation
  cat("### Genome annotation\n\n")
  emit_dir(genome_ann_path, recursive = TRUE, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px)

  # Functional groups
  if (isTRUE(params$run_functional_groups)) {
    fg_dir <- file.path(genome_ann_path, "functional_groups")
    if (dir.exists(fg_dir)) {
      cat("### Functional groups\n\n")
      emit_dir(fg_dir, recursive = TRUE, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px)
    }
  }

  # BigWigs
  if (dir.exists(DMRs_bigWig_path)) {
    bw <- list.files(DMRs_bigWig_path, pattern = "\\.(bw|bigWig)$", full.names = FALSE, ignore.case = TRUE)
    if (length(bw) > 0) {
      cat("### BigWig tracks\n\n")
      cat("These tracks can be loaded in IGV.\n\n")
      cat(paste0("- ", bw, collapse = "\n"), "\n\n")
    }
  }

  # GO / KEGG (plots only)
  if (isTRUE(params$run_GO_analysis)) {
    cat("### GO analysis\n\n")
    emit_dir(file.path(exp_path, "GO_analysis"), recursive = TRUE, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px)
  }
  if (isTRUE(params$run_KEGG_pathways)) {
    cat("### KEGG pathways\n\n")
    emit_dir(file.path(exp_path, "KEGG_pathway"), recursive = TRUE, cols = params$default_plot_cols, max_height_px = params$plot_max_height_px)
  }
} else {
  cat("_DMR analysis is disabled (analyze_DMRs=FALSE)._\\n\\n")
}
```

## Other analyses

```{r other, results='asis'}
if (isTRUE(params$analyze_strand_asymmetry_DMRs)) {
  cat("### Strand-asymmetry DMRs\n\n")
  emit_dir(strand_asymmetry_path, recursive = TRUE, cols = params$default_plot_cols)
}

if (isTRUE(params$analyze_DMVs)) {
  cat("### DMVs (1kb)\n\n")
  cat("DMV tables can be large, so this report only lists output file sizes.\n\n")
  if (dir.exists(DMV_analysis_path)) {
    csvs <- list.files(DMV_analysis_path, pattern = "\\.csv$", full.names = TRUE, ignore.case = TRUE)
    if (length(csvs) > 0) {
      info <- file.info(csvs)
      out <- data.frame(File = basename(csvs), Size_MB = round(info$size/(1024^2),2), Modified = format(info$mtime, "%Y-%m-%d %H:%M"), check.names = FALSE)
      kable(out)
      cat("\n\n")
    }
    emit_dir(DMV_analysis_path, recursive = TRUE, cols = params$default_plot_cols)
  }
}

if (isTRUE(params$analyze_dH)) {
  cat("### ΔH / entropy\n\n")
  cat("ΔH captures changes in methylation heterogeneity (stochasticity) rather than only mean methylation.\n\n")
  emit_dir(dH_path, recursive = TRUE, cols = params$default_plot_cols)
  if (dir.exists(dH_ann_path)) {
    cat("#### ΔH genome annotation\n\n")
    emit_dir(dH_ann_path, recursive = TRUE, cols = params$default_plot_cols)
  }
}

if (isTRUE(params$run_TE_metaPlots) || isTRUE(params$run_GeneBody_metaPlots) || isTRUE(params$run_GeneFeatures_metaPlots)) {
  cat("### MetaPlots\n\n")
  if (is.na(meta_dir)) {
    cat("_No MetaPlots/metaPlots folder found._\n\n")
  } else {
    if (isTRUE(params$run_GeneBody_metaPlots)) {
      cat("#### Gene-body metaPlots\n\n")
      emit_dir(file.path(meta_dir, "Genes"), recursive = TRUE, cols = params$default_plot_cols)
    }
    if (isTRUE(params$run_TE_metaPlots)) {
      cat("#### TE metaPlots\n\n")
      emit_dir(file.path(meta_dir, "TEs"), recursive = TRUE, cols = params$default_plot_cols)
    }
    if (isTRUE(params$run_GeneFeatures_metaPlots)) {
      cat("#### Gene-features metaPlots\n\n")
      emit_dir(file.path(meta_dir, "Gene_features"), recursive = TRUE, cols = params$default_plot_cols)
    }
  }
}
```

## Session {.tabset}

### Configurations

```{r params-table, results='asis'}
pnames <- names(params)
vals <- vapply(pnames, function(n) val1(params[[n]]), character(1))
cfg <- data.frame(Parameter = pnames, Value = vals, check.names = FALSE, stringsAsFactors = FALSE)
kable(cfg)
```

### Session info

```{r session-info, results='asis'}
si <- capture.output(sessionInfo())
cat("<div style='max-width:900px; margin:0 auto;'><pre style='font-size:90%'>", paste(si, collapse = "\n"), "</pre></div>", sep = "")
```
