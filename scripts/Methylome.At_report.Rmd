---
title: "Methylome.At Report"
author: "Methylome.At"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    number_sections: true
params:
  cond1: "control"
  cond2: "treatment"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.width = 7,
  fig.height = 5,
  out.width = "80%"
)

library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(purrr)
library(stringr)
library(tools)

cond1 <- params$cond1
cond2 <- params$cond2
contrast <- paste0(cond2, "_vs_", cond1)
results_dir <- paste0("./results/", contrast, "/")

read_if_exists <- function(path, ...) {
  if (file.exists(path)) {
    readr::read_csv(path, show_col_types = FALSE, ...)
  } else {
    NULL
  }
}

include_if_exists <- function(path) {
  if (file.exists(path)) {
    return(knitr::include_graphics(normalizePath(path)))
  }
  base <- tools::file_path_sans_ext(path)
  exts <- c(".png", ".pdf", ".svg", ".tif", ".tiff", ".jpg", ".jpeg")
  for (e in exts) {
    alt <- paste0(base, e)
    if (file.exists(alt)) {
      return(knitr::include_graphics(normalizePath(alt)))
    }
  }
  invisible(NULL)
}
```

# Overview

**`r cond2` vs `r cond1`**

This report summarizes the outputs produced by **Methylome.At** for this contrast.

# Chloroplast conversion rate

```{r conversion-rate}
conv_path <- file.path(results_dir, "conversion_rate.csv")
conv <- read_if_exists(conv_path)

if (!is.null(conv)) {
  conv %>%
    mutate(conversion_rate = paste0(round(as.numeric(conversion_rate), 2), "%")) %>%
    kable(col.names = c("Sample", "Conversion Rate"), align = "lc") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# PCA - sample relationships

```{r pca-all, out.width="60%", fig.cap="PCA: All contexts combined"}
pca_dir <- file.path(results_dir, "PCA_plots")
include_if_exists(file.path(pca_dir, paste0("all_contexts_PCA_plot_", contrast)))
```

```{r pca-contexts, out.width="32%", fig.show='hold', fig.cap="PCA by methylation context"}
include_if_exists(file.path(pca_dir, paste0("CG_PCA_plot_", contrast)))
include_if_exists(file.path(pca_dir, paste0("CHG_PCA_plot_", contrast)))
include_if_exists(file.path(pca_dir, paste0("CHH_PCA_plot_", contrast)))
```

# Total methylation levels

```{r methylation-levels}
meth_dir <- file.path(results_dir, "methylation_levels")

wg  <- read_if_exists(file.path(meth_dir, paste0("Whole_Genome_", contrast, ".csv")))
eu  <- read_if_exists(file.path(meth_dir, paste0("Euchromatin_region_", contrast, ".csv")))
het <- read_if_exists(file.path(meth_dir, paste0("Heterochromatin_region_", contrast, ".csv")))

add_region <- function(df, region_label) {
  if (is.null(df)) return(NULL)
  df %>% mutate(region = region_label)
}

meth_all <- bind_rows(
  add_region(wg,  "Whole genome"),
  add_region(eu,  "Euchromatin"),
  add_region(het, "Heterochromatin")
)

if (!is.null(meth_all) && nrow(meth_all) > 0) {
  meth_all %>%
    arrange(region, type, treatment) %>%
    kable(caption = "Mean methylation levels by region, context and treatment", digits = 2) %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

```{r methylation-levels-figs, out.width="32%", fig.show='hold', fig.cap="Methylation levels"}
include_if_exists(file.path(meth_dir, paste0("Whole_Genome_", contrast)))
include_if_exists(file.path(meth_dir, paste0("Euchromatin_region_", contrast)))
include_if_exists(file.path(meth_dir, paste0("Heterochromatin_region_", contrast)))
```

# Chromosome-level methylation

```{r chr-cx, out.width="90%", fig.cap="Chromosome-level CX methylation profiles"}
cx_dir <- file.path(results_dir, "ChrPlot_CX")
include_if_exists(file.path(cx_dir, paste0("ChrPlot_", contrast)))
```

```{r chr-cx-diff, out.width="90%", fig.cap="Chromosome-level methylation difference"}
include_if_exists(file.path(cx_dir, paste0("ChrPlot_difference_", contrast)))
```

# DMR statistics

## Summary

```{r dmrs-summary}
dmr_files <- list(
  CG  = file.path(results_dir, paste0("DMRs_CG_",  contrast, ".csv")),
  CHG = file.path(results_dir, paste0("DMRs_CHG_", contrast, ".csv")),
  CHH = file.path(results_dir, paste0("DMRs_CHH_", contrast, ".csv"))
)

dmr_list <- imap(dmr_files, ~{
  df <- read_if_exists(.x)
  if (!is.null(df)) df$context <- .y
  df
})

dmrs <- bind_rows(dmr_list[!map_lgl(dmr_list, is.null)])

if (!is.null(dmrs) && nrow(dmrs) > 0) {
  if (!"regionType" %in% names(dmrs)) dmrs$regionType <- NA_character_
  
  dmr_summary <- dmrs %>%
    count(context, regionType, name = "n_DMRs") %>%
    pivot_wider(names_from = regionType, values_from = n_DMRs, values_fill = 0) %>%
    mutate(Total = rowSums(across(where(is.numeric)), na.rm = TRUE))
  
  kable(dmr_summary, caption = "DMR counts by context and direction") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

## Density plot

```{r dmrs-density, out.width="55%", fig.cap="DMR density across chromosomes"}
include_if_exists(file.path(results_dir, paste0("DMRs_Density_", contrast)))
```

## Gain vs Loss

```{r dmrs-gain-loss-pie, out.width="30%", fig.show='hold', fig.cap="DMR direction"}
gol_dir <- file.path(results_dir, "gain_OR_loss")
include_if_exists(file.path(gol_dir, "pie_CG_gainORloss"))
include_if_exists(file.path(gol_dir, "pie_CHG_gainORloss"))
include_if_exists(file.path(gol_dir, "pie_CHH_gainORloss"))
```

```{r dmrs-gain-loss-ratio, out.width="32%", fig.show='hold', fig.cap="DMR ratio distribution"}
include_if_exists(file.path(gol_dir, "ratio.distribution_CG_gainORloss"))
include_if_exists(file.path(gol_dir, "ratio.distribution_CHG_gainORloss"))
include_if_exists(file.path(gol_dir, "ratio.distribution_CHH_gainORloss"))
```

# Genome annotation for DMRs

```{r genome-annotation-figs, out.width="30%", fig.show='hold', fig.cap="DMR distribution across genomic features"}
annot_dir <- file.path(results_dir, "genome_annotation")
include_if_exists(file.path(annot_dir, "CG_genom_annotations"))
include_if_exists(file.path(annot_dir, "CHG_genom_annotations"))
include_if_exists(file.path(annot_dir, "CHH_genom_annotations"))
```

```{r genome-annotation-legend, out.width="20%", fig.cap="Legend"}
include_if_exists(file.path(annot_dir, "legend_genom_annotations"))
```

# TE superfamilies analysis

```{r te-superfamilies-circular, out.width="48%", fig.show='hold', fig.cap="TE superfamily DMR distribution"}
te_dir <- file.path(results_dir, "TEs_addiotionnal_results")
include_if_exists(file.path(te_dir, "TEs_lines_density_superfamilies"))
include_if_exists(file.path(te_dir, "TEs_direction_density_superfamilies"))
```

# Functional gene groups

```{r gene-groups-figs, out.width="90%", fig.cap="DMRs in functional gene groups"}
groups_dir <- file.path(results_dir, "genome_annotation", "functional_groups")

for (ctx in c("CG", "CHG", "CHH")) {
  ctx_dir <- file.path(groups_dir, ctx)
  if (dir.exists(ctx_dir)) {
    for (ann in c("Genes", "Promoters")) {
      fig_path <- file.path(ctx_dir, paste0(ctx, "_", ann, "_groups_volcano_", contrast))
      result <- include_if_exists(fig_path)
      if (!is.null(result)) print(result)
    }
  }
}
```

# Metaplots

## Gene body metaplots

```{r metaplots-genes, out.width="32%", fig.show='hold', fig.cap="Methylation profiles around genes"}
metaplot_dir <- file.path(results_dir, "metaPlots", "Genes")
include_if_exists(file.path(metaplot_dir, paste0("Genes_CG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir, paste0("Genes_CHG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir, paste0("Genes_CHH_metaPlot_", contrast)))
```

```{r metaplots-genes-delta, out.width="40%", fig.cap="Gene body methylation difference"}
include_if_exists(file.path(metaplot_dir, paste0("Genes_delta_metaPlot_", contrast)))
```

## TE body metaplots

```{r metaplots-tes, out.width="32%", fig.show='hold', fig.cap="Methylation profiles around TEs"}
metaplot_dir_te <- file.path(results_dir, "metaPlots", "TEs")
include_if_exists(file.path(metaplot_dir_te, paste0("TEs_CG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir_te, paste0("TEs_CHG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir_te, paste0("TEs_CHH_metaPlot_", contrast)))
```

```{r metaplots-tes-delta, out.width="40%", fig.cap="TE body methylation difference"}
include_if_exists(file.path(metaplot_dir_te, paste0("TEs_delta_metaPlot_", contrast)))
```

## Gene feature metaplots

```{r metaplots-features, out.width="48%", fig.show='hold', fig.cap="Methylation profiles across gene sub-features"}
metaplot_dir_feat <- file.path(results_dir, "metaPlots", "Gene_features")
include_if_exists(file.path(metaplot_dir_feat, paste0("Genes_features_CG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir_feat, paste0("Genes_features_CHG_metaPlot_", contrast)))
include_if_exists(file.path(metaplot_dir_feat, paste0("Genes_features_CHH_metaPlot_", contrast)))
```

# BigWig output

```{r bigwig-summary}
bw_dir <- file.path(results_dir, "DMRs_bigWig")

if (dir.exists(bw_dir)) {
  bw_files <- list.files(bw_dir, pattern = "\\.bw$", full.names = FALSE)
  
  if (length(bw_files) > 0) {
    tibble(File = bw_files) %>%
      mutate(
        Context = str_extract(File, "CG|CHG|CHH"),
        Description = "DMR log2FC track for genome browser"
      ) %>%
      kable(align = "llc") %>%
      kable_styling(bootstrap_options = c("striped"), full_width = FALSE)
  } else {
    cat("No BigWig files found.\n")
  }
} else {
  cat("BigWig directory not found.\n")
}
```

# GO and KEGG enrichment

```{r go-kegg-tables}
go_dir <- file.path(results_dir, "GO & KEGG analysis")

if (dir.exists(go_dir)) {
  go_files <- list.files(go_dir, pattern = "\\.topGO\\.csv$", recursive = TRUE, full.names = TRUE)
  kegg_files <- list.files(go_dir, pattern = "\\.KEGG\\.csv$", recursive = TRUE, full.names = TRUE)
  
  if (length(go_files) > 0) {
    go_df <- read_if_exists(go_files[1])
    if (!is.null(go_df) && nrow(go_df) > 0) {
      go_df %>%
        slice_head(n = 8) %>%
        select(any_of(c("GO.ID", "Term", "Significant", "Annotated", "Fisher"))) %>%
        kable(caption = paste("GO enrichment example:", basename(go_files[1])), digits = 4) %>%
        kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
    }
  }
  
  if (length(kegg_files) > 0) {
    kegg_df <- read_if_exists(kegg_files[1])
    if (!is.null(kegg_df) && nrow(kegg_df) > 0) {
      kegg_df %>%
        slice_head(n = 8) %>%
        select(any_of(c("pathway.code", "pathway.name", "Significant", "Annotated", "p.value"))) %>%
        kable(caption = paste("KEGG enrichment example:", basename(kegg_files[1])), digits = 4) %>%
        kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
    }
  }
}
```

```{r go-kegg-figs, out.width="90%", fig.cap="GO and KEGG enrichment plots"}
if (dir.exists(go_dir)) {
  plot_files <- list.files(go_dir, pattern = paste0(contrast, ".*\\.(png|pdf)$"), full.names = TRUE, recursive = FALSE)
  for (pf in head(plot_files, 6)) {
    result <- include_if_exists(pf)
    if (!is.null(result)) print(result)
  }
}
```

# Session information

```{r session-info}
sessionInfo()
```